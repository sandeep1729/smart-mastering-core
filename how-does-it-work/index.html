<!doctype html>
<!--[if lt IE 7 ]><html itemscope itemtype="http://schema.org/Organization" id="ie6" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 7 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie7" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 8 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie8" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 9 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie9" class="ie" lang="en-US"><![endif]-->
<!--[if gt IE 9]><!--><html itemscope itemtype="http://schema.org/Organization" lang="en-US"><!--<![endif]-->
<head>

    <!-- Meta -->
    <meta charset="utf-8">
    <title>How Does it Work? - Smart Mastering</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Favicons -->
    <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64 96x96" href="/smart-mastering-core/favicon.ico">
    <meta name="application-name" content="Smart Mastering - A Smart Mastering framework for MarkLogic">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-6638631-15', 'auto');
      ga('send', 'pageview');

    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
    document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1879746318909687'); // Insert your pixel ID here.
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1879746318909687&ev=PageView&noscript=1"
    /></noscript>
    <!-- DO NOT MODIFY -->
    <!-- End Facebook Pixel Code -->
    <link type="text/css" rel="stylesheet" href="/smart-mastering-core/assets/bundle.css">
</head>
<body class="">

    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/smart-mastering-core">
                  <span class="logo">
                    <img src="/smart-mastering-core/images/logo-marklogic.svg" width="180px" height="38px" alt="MarkLogic" title="MarkLogic" scale="0">
                  </span>
                  Smart Mastering
                  <img src="/smart-mastering-core/images/smart-mastering.svg" width="36x" height="36px">
                </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    
                        <li  >
                            
                            <a href="/smart-mastering-core/">Getting Started</a>
                            
                        </li>
                    
                        <li  >
                            
                            <a href="https://github.com/marklogic-community/smart-mastering-core">GitHub</a>
                            
                        </li>
                    
                </ul>
            </div>
        </div>
    </nav>




  <article>
    <div class="container">
      <div class="row">
        <div class="side-nav col-md-3 hide-small">
          <div class="panel panel-default">
  <div class="panel-heading">Navigation</div>
  <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/">Getting Started</a>
    
    
  </li>
  
  <li  class="list-group-item active"  >
    
    <a href="/smart-mastering-core/how-does-it-work/">How Does it Work?</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/how-to-use/">How do I Use it?</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/">Docs</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/rest/">REST API</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/libraries/">Libraries</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/matching-options/">Matching Options</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/match-algorithms/">Included Matching Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/custom-match-algorithms/">Custom Matching Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/actions/">Included Actions</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/custom-actions/">Custom Actions</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/merging-options/">Merging Options</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/merge-algorithms/">Included Merging Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/custom-merge-algorithms/">Custom Merging Algorithms</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/managing-code/">Managing Custom Code</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/security/">Security</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/error-codes/">Error Codes</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/faqs/">FAQs</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/troubleshooting/">Troubleshooting</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="https://github.com/marklogic-community/smart-mastering-core">Smart Mastering on GitHub</a>
    
    
  </li>
  
</ul>

</div>

        </div>
        <div class="col-md-9">
          <h1 id="how-does-it-work">How Does it Work?</h1>

<p>Smart Mastering consists of configuration-driven matching and merging. While
the <a href="../how-to-use/">How To Use</a> page will show you how to access this
functionality, this page describes the matching and merging processes that
make up Smart Mastering.</p>

<p>The Smart Mastering process focuses on one document at a time, identifying
any other documents that appear to represent the same entity (Matching) and
then combining the values in those documents to create a new document (Merging).
Matching and merging are run across either <a href="https://mlu.marklogic.com/ondemand/931812fc">harmonized</a> XML or harmonized 
JSON documents.</p>

<h2 id="collections">Collections</h2>

<p>Smart Mastering Core uses collections to separate types of content. Applications
should use <a href="https://github.com/marklogic-community/smart-mastering-core/blob/master/src/main/ml-modules/root/com.marklogic.smart-mastering/constants.xqy"><code class="highlighter-rouge">constants.xqy</code></a> for the names of the collections. The
most important collection is <code class="highlighter-rouge">$CONTENT-COLL</code>, which contains the current set of
entities that should be used by an application. When a set of documents get
merged, they are moved out of that collection and into the <code class="highlighter-rouge">$ARCHIVED-COLL</code>
collection. The generated merged document will be in the <code class="highlighter-rouge">$CONTENT-COLL</code> and
<code class="highlighter-rouge">$MERGED-COLL</code> collections. Documents can also be unmerged, in which case the
merged document will go to the <code class="highlighter-rouge">$ARCHIVED-COLL</code>.</p>

<h2 id="matching">Matching</h2>

<p>The matching process begins with a document, which we’ll call the “original”
document. This document may be selected because it’s just been inserted into the
database, or because a process is cycling through all content.</p>

<p><img src="/smart-mastering-core/images/matching.png" alt="Matching Process" /></p>

<ol>
  <li>The original document gets inserted into the database and the matching
process begins.</li>
  <li>The matcher uses the <a href="../docs/matching-options/">match configuration</a> and the original
document to determine the properties and values that will be used for matching.</li>
  <li>The property values are turned into a query that optionally gets combined with a user-provided filtering query used to restrict matches to a set, such as a specific entity type or collection.</li>
  <li>The matcher runs the combined query to identify potential matches for the original
document.</li>
</ol>

<p>The query will be run once, generating a score-ordered sequence of
potential matches, each of which is labeled according to a threshold of match
probability. A match response will look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;result uri="/source/3/doc3.json" index="1" score="79" threshold="Definitive Match" action="merge"&gt;
</code></pre></div></div>

<p>Smart Mastering expects that the documents it is working with are either all
XML or all JSON, rather than mixed. If the content that mastering runs on is
mixed, then behavior is undefined.</p>

<h3 id="matching-algorithms">Matching Algorithms</h3>

<p>The default query to look for documents with property values that match the
original document is a <code class="highlighter-rouge">cts:element-value-query</code>, looking for the exact same
value that the original document has. In some cases, you might want to provide
more flexibility in defining what a match is. For those cases, you can specify
an algorithm.</p>

<p>A matching algorithm function takes the value(s) of a single property from the
original document, along with the match configuration, and uses that to generate
a query to find other documents that have relevant values for the same property.
This function will be run once for each original document. This is a normal
XQuery or SJS function, so it can make database queries, call out to third-party
services, or do anything else needed to generate that query.</p>

<p>To see an example of a matching algorithm function, see <a href="https://github.com/marklogic-community/smart-mastering-core/blob/master/src/main/ml-modules/root/com.marklogic.smart-mastering/algorithms/zip.xqy">zip.xqy</a>.</p>

<h2 id="merging">Merging</h2>

<p>Merging takes a set of documents and creates a new document to represent the
combination. The structure of the document will match the originals, which are
assumed to have been harmonized. The merge configuration controls how property
values from the input documents are preserved in the new document.</p>

<p>When two or more documents get merged, they are removed from the
<a href="https://github.com/marklogic-community/smart-mastering-core/blob/master/src/main/ml-modules/root/com.marklogic.smart-mastering/constants.xqy"><code class="highlighter-rouge">$CONTENT-COLL</code></a>. A new document is added to the
<a href="https://github.com/marklogic-community/smart-mastering-core/blob/master/src/main/ml-modules/root/com.marklogic.smart-mastering/constants.xqy"><code class="highlighter-rouge">$CONTENT-COLL</code></a> and to the <a href="https://github.com/marklogic-community/smart-mastering-core/blob/master/src/main/ml-modules/root/com.marklogic.smart-mastering/constants.xqy"><code class="highlighter-rouge">$MERGED-COLL</code></a>. Smart
Mastering Core will record that these documents were combined into the new one,
including the source for each property value in the merged document. This allows
an application to observe the history of a document and its properties, as well
as to undo a merge.</p>

<h3 id="merging-algorithms">Merging Algorithms</h3>

<p>There is a standard algorithm available to combine properties, which is
described on the <a href="../docs/merging-options/">Merging Options</a> page.</p>

<p>Smart Mastering Core also supports custom merge algorithms. This function takes
the <code class="highlighter-rouge">xs:QName</code> for an XML element or a JSON property name, values from the 
input documents, and the <code class="highlighter-rouge">merging/merge</code> configuration of this property (see
<a href="../docs/merging-options/">merging options</a>). The function returns an ordered list of
property values, with the length of the sequence and the ordering defined by the
algorithm. Note that the algorithm does not need to only gather or choose among
values from the input documents; it may choose to aggregate those values.</p>

<p>To see examples of custom algorithms, see the unit tests in the <a href="https://github.com/marklogic-community/smart-mastering-core/tree/master/src/test/ml-modules/root/test/suites/merging-xml"><code class="highlighter-rouge">merging</code> test
suite</a>.</p>

<h3 id="auditing">Auditing</h3>

<p>By default, Auditing events are automatically stored for merging and unmerging. These auditing events are stored as as <a href="https://www.w3.org/TR/prov-o/">prov-o</a> triples and <a href="https://www.w3.org/TR/prov-xml/">prov-xml</a> xml documents.</p>

<p><strong>NOTE</strong>: In order for auditing to work you must have a schemas database assigned to your content database.</p>

<h2 id="data-model">Data Model</h2>

<p>The Smart Mastering library expects data to use the Entity Services envelope structure. This means that the root of a 
document will have <code class="highlighter-rouge">envelope</code> as the local name, with <code class="highlighter-rouge">http://marklogic.com/entity-services</code> as the namespace for XML.</p>

<p>Underneath the <code class="highlighter-rouge">envelope</code> root, Entity Services envelopes have four children (each in the 
<code class="highlighter-rouge">http://marklogic.com/entity-services</code> namespace when using XML):</p>
<ul>
  <li><code class="highlighter-rouge">headers</code>: metadata about the document</li>
  <li><code class="highlighter-rouge">triples</code>: semantic information that is materialized in the document</li>
  <li><code class="highlighter-rouge">instance</code>: harmonized properties</li>
  <li><code class="highlighter-rouge">attachments</code>: source data in its original form</li>
</ul>

<p>The standard merge algorithm’s recency and source-preference sorting capabilities both rely on identifying the sources. 
Smart Mastering expects to find the sources under <code class="highlighter-rouge">/es:envelope/es:headers/sm:sources/sm:source</code> for XML or 
<code class="highlighter-rouge">/envelope/headers/sources/source</code> for JSON data. For example in XML</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;envelope</span> <span class="na">xmlns=</span><span class="s">"http://marklogic.com/entity-services"</span> 
    <span class="na">xmlns:sm=</span><span class="s">"http://marklogic.com/smart-mastering"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;headers&gt;</span>
    <span class="nt">&lt;sm:id&gt;</span>bbc806e4-ff00-4585-9d46-877edbc3248e<span class="nt">&lt;/sm:id&gt;</span>
    <span class="nt">&lt;sm:sources&gt;</span>
      <span class="nt">&lt;sm:source&gt;</span>
        <span class="nt">&lt;sm:name&gt;</span>SOURCE1<span class="nt">&lt;/sm:name&gt;</span>
      <span class="nt">&lt;/sm:source&gt;</span>
    <span class="nt">&lt;/sm:sources&gt;</span>
    <span class="c">&lt;!-- es:triples, es:instance, and es:attachments not shown --&gt;</span>
  <span class="nt">&lt;/headers&gt;</span>
</code></pre></div></div>

<p>and in JSON:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"envelope"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"sources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MMIS"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">triples</span><span class="p">,</span><span class="w"> </span><span class="err">instance</span><span class="p">,</span><span class="w"> </span><span class="err">and</span><span class="w"> </span><span class="err">attachments</span><span class="w"> </span><span class="err">properties</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">shown</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>For more information about sorting by timestamps, see the <a href="../docs/merging-options/#timestamp">Timestamps</a> section of 
the Merging Options page.</p>

<p>For more information about the Envelope pattern, see <a href="https://docs.marklogic.com/guide/entity-services/instances#id_67461">What is an Envelope Document</a> in the Entity Services 
Developer’s Guide.</p>


        </div>
      </div>
    </div>
  </article>


    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>
                    Copyright © 2016-2018 MarkLogic Corporation. All Rights Reserved. MARKLOGIC® is a registered trademark of MarkLogic Corporation.
                    </p>
                </div>
            </div>
        </div>
    </footer>


    <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="/smart-mastering-core/js/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/smart-mastering-core/assets/bundle.js" id="1"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-79716597-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>

