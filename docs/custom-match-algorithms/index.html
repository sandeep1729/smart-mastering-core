<!doctype html>
<!--[if lt IE 7 ]><html itemscope itemtype="http://schema.org/Organization" id="ie6" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 7 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie7" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 8 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie8" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 9 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie9" class="ie" lang="en-US"><![endif]-->
<!--[if gt IE 9]><!--><html itemscope itemtype="http://schema.org/Organization" lang="en-US"><!--<![endif]-->
<head>

    <!-- Meta -->
    <meta charset="utf-8">
    <title>Custom Match Algorithms - Smart Mastering</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Favicons -->
    <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64 96x96" href="/smart-mastering-core/favicon.ico">
    <meta name="application-name" content="Smart Mastering - A Smart Mastering framework for MarkLogic">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-6638631-15', 'auto');
      ga('send', 'pageview');

    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
    document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1879746318909687'); // Insert your pixel ID here.
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1879746318909687&ev=PageView&noscript=1"
    /></noscript>
    <!-- DO NOT MODIFY -->
    <!-- End Facebook Pixel Code -->
    <link type="text/css" rel="stylesheet" href="/smart-mastering-core/assets/bundle.css">
</head>
<body class="">

    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/smart-mastering-core">
                  <span class="logo">
                    <img src="/smart-mastering-core/images/logo-marklogic.svg" width="180px" height="38px" alt="MarkLogic" title="MarkLogic" scale="0">
                  </span>
                  Smart Mastering
                  <img src="/smart-mastering-core/images/smart-mastering.svg" width="36x" height="36px">
                </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    
                        <li  >
                            
                            <a href="/smart-mastering-core/">Getting Started</a>
                            
                        </li>
                    
                        <li  >
                            
                            <a href="https://github.com/marklogic-community/smart-mastering-core">GitHub</a>
                            
                        </li>
                    
                </ul>
            </div>
        </div>
    </nav>




  <article>
    <div class="container">
      <div class="row">
        <div class="side-nav col-md-3 hide-small">
          <div class="panel panel-default">
  <div class="panel-heading">Navigation</div>
  <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/">Getting Started</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/how-does-it-work/">How Does it Work?</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/how-to-use/">How do I Use it?</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/">Docs</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/rest/">REST API</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/libraries/">Libraries</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/matching-options/">Matching Options</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/match-algorithms/">Included Matching Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item active"  >
    
    <a href="/smart-mastering-core/docs/custom-match-algorithms/">Custom Matching Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/actions/">Included Actions</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/custom-actions/">Custom Actions</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/merging-options/">Merging Options</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/merge-algorithms/">Included Merging Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/custom-merge-algorithms/">Custom Merging Algorithms</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/managing-code/">Managing Custom Code</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/security/">Security</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/error-codes/">Error Codes</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/faqs/">FAQs</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/troubleshooting/">Troubleshooting</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="https://github.com/marklogic-community/smart-mastering-core">Smart Mastering on GitHub</a>
    
    
  </li>
  
</ul>

</div>

        </div>
        <div class="col-md-9">
          <h1 id="custom-match-algorithms">Custom Match Algorithms</h1>

<p>Smart Mastering provides out-of-the-box matching capabilities, but you may want
to customize how that matching happens. The default behavior is simple: for a
particular property, if two documents have exactly the same values for that 
property, then the property is a match. Each property is configured with a 
weight that contributes to a match score between two documents.</p>

<p>If you want to take more control over what it means for two property values to 
match, you can do so by implementing your own algorithm in a function.</p>

<h2 id="harmonization-and-smart-mastering">Harmonization and Smart Mastering</h2>

<p>Note that Smart Mastering is intended to be run after harmonization, so 
normally at the least the document structures will be the same; generally, the 
values should have been standardized as well.</p>

<p>As an example, suppose your document has a “state” property, corresponding to 
the US state in which a person lives. You might have some sources that use the
state’s name (“Pennsylvania”), others that use the 2-letter code (“PA”), and 
still others that use the state’s official, full name (“Commonwealth of
Pennsylvania”). Your harmonization process will normally make sure that not 
only are the state values from all sources put into the same property name 
“state-code”, but that the values are standardized using one format (“PA”). In
this case, it would not be necessary to use a custom algorithm to compare 
properties.</p>

<h2 id="customizing-matching">Customizing Matching</h2>

<p>Sometimes data sources simply have different levels of information. Zip codes
are a good example. In the United States, an address includes a zip code, which
may have either five (“19106”) or nine (“19106-2320”) digits. A nine-digit zip 
code identifies a more precise location and is entirely contained within the 
area of the five-digit zip code that it starts with. <a href="https://github.com/marklogic-community/smart-mastering-core/blob/master/src/main/ml-modules/root/com.marklogic.smart-mastering/algorithms/zip.xqy">zip.xqy</a> 
implements an algorithm that gives points if the 5-digit portion of a 9-digit
zip code matches a 5-digit zip code.</p>

<p>Matching looks for candidate matches for a particular document. It does this by
building a query based on configured properties and the values of those 
properties in the document.</p>

<h3 id="javascript">JavaScript</h3>

<p>To implement your own algorithm in Javascript, create a function with this 
signature:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">zipMatch</span><span class="p">(</span>
  <span class="nx">expandValues</span><span class="p">,</span>
  <span class="nx">expandXML</span><span class="p">,</span>
  <span class="nx">optionsXML</span>
<span class="p">)</span>
</code></pre></div></div>
<p>The <code class="highlighter-rouge">expandValues</code> parameter contains the value or values from the document. 
The <code class="highlighter-rouge">expandXML</code> parameter is the portion of <code class="highlighter-rouge">expand</code> element of the match 
options that corresponds to the target property. The <code class="highlighter-rouge">optionsXML</code> is the 
complete match options.</p>

<p>Your function must return zero or more queries. You can return zero if your 
function decides that this property should not be a factor in matching (for 
instance, if the original document does not have a value for this property).</p>

<h3 id="xquery">XQuery</h3>

<p>To implement your own algorithm in XQuery, create a function with this 
signature:</p>

<div class="language-xquery highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">declare</span> <span class="kd">function</span> <span class="nf">algorithms:zip-match</span><span class="p">(</span>
  <span class="nv">$</span><span class="n">expand-values</span> <span class="k">as</span> <span class="kt">xs:string</span><span class="o">*</span><span class="p">,</span>
  <span class="nv">$</span><span class="n">expand-xml</span> <span class="k">as</span> <span class="nt">element</span><span class="p">(</span><span class="n">matcher:expand</span><span class="p">),</span>
  <span class="nv">$</span><span class="n">options-xml</span> <span class="k">as</span> <span class="nt">element</span><span class="p">(</span><span class="n">matcher:options</span><span class="p">)</span>
<span class="p">)</span> <span class="k">as</span> <span class="kt">cts:query</span><span class="o">*</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">$expand-values</code> parameter contains the value or values from the document. 
The <code class="highlighter-rouge">$expand-xml</code> parameter is the portion of <code class="highlighter-rouge">expand</code> element of the match 
options that corresponds to the target property. The <code class="highlighter-rouge">$options-xml</code> is the 
complete match options.</p>

<p>Your function must return zero or more queries. You can return zero if your 
function decides that this property should not be a factor in matching (for 
instance, if the original document does not have a value for this property).</p>

<h2 id="configuring-options-to-use-custom-match-functions">Configuring Options to Use Custom Match Functions</h2>

<p>To use your custom match functions, add them to the <code class="highlighter-rouge">algorithms</code> section of your match options. The 
<code class="highlighter-rouge">algorithm-ref</code>/<code class="highlighter-rouge">algorithmRef</code> used for the <code class="highlighter-rouge">expand</code> definitions refers to the name you assign in the <code class="highlighter-rouge">algorithms</code> 
section.</p>

<p>The <code class="highlighter-rouge">algorithm</code> needs <code class="highlighter-rouge">name</code>, <code class="highlighter-rouge">at</code>, <code class="highlighter-rouge">function</code>, and for XQuery functions, <code class="highlighter-rouge">ns</code> in order to find your custom code. The 
<code class="highlighter-rouge">at</code> property is the absolute path the library module in the modules database that holds your function. <code class="highlighter-rouge">ns</code> is the 
namespace in an XQuery library module. <code class="highlighter-rouge">function</code> is the actual name of the function (not including the namespace or 
prefix for XQuery code).</p>

<h3 id="xml-options">XML Options</h3>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;algorithms&gt;</span>
    <span class="nt">&lt;algorithm</span> 
      <span class="na">name=</span><span class="s">"favorite-color"</span> 
      <span class="na">at=</span><span class="s">"/smart-mastering/match/favorite-color.xqy"</span> 
      <span class="na">namespace=</span><span class="s">"http://example.com/big-hub/smart-mastering/match/favorite-color"</span>
      <span class="na">function=</span><span class="s">"favorite-color"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/algorithms&gt;</span>
</code></pre></div></div>

<h3 id="json-options">JSON Options</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="s2">"algorithms"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"algorithm"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> 
          <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"favoriteColor"</span><span class="p">,</span> 
          <span class="s2">"at"</span><span class="p">:</span> <span class="s2">"/smart-mastering/match/favoriteColor.sjs"</span>
          <span class="s2">"function"</span><span class="p">:</span> <span class="s2">"favoriteColor"</span> 
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
</code></pre></div></div>


        </div>
      </div>
    </div>
  </article>


    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>
                    Copyright © 2016-2018 MarkLogic Corporation. All Rights Reserved. MARKLOGIC® is a registered trademark of MarkLogic Corporation.
                    </p>
                </div>
            </div>
        </div>
    </footer>


    <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="/smart-mastering-core/js/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/smart-mastering-core/assets/bundle.js" id="1"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-79716597-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>

