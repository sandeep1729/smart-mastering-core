<!doctype html>
<!--[if lt IE 7 ]><html itemscope itemtype="http://schema.org/Organization" id="ie6" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 7 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie7" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 8 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie8" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 9 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie9" class="ie" lang="en-US"><![endif]-->
<!--[if gt IE 9]><!--><html itemscope itemtype="http://schema.org/Organization" lang="en-US"><!--<![endif]-->
<head>

    <!-- Meta -->
    <meta charset="utf-8">
    <title>Custom Merge Algorithms - Smart Mastering</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Favicons -->
    <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64 96x96" href="/smart-mastering-core/favicon.ico">
    <meta name="application-name" content="Smart Mastering - A Smart Mastering framework for MarkLogic">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-6638631-15', 'auto');
      ga('send', 'pageview');

    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
    document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1879746318909687'); // Insert your pixel ID here.
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1879746318909687&ev=PageView&noscript=1"
    /></noscript>
    <!-- DO NOT MODIFY -->
    <!-- End Facebook Pixel Code -->
    <link type="text/css" rel="stylesheet" href="/smart-mastering-core/assets/bundle.css">
</head>
<body class="">

    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/smart-mastering-core">
                  <span class="logo">
                    <img src="/smart-mastering-core/images/logo-marklogic.svg" width="180px" height="38px" alt="MarkLogic" title="MarkLogic" scale="0">
                  </span>
                  Smart Mastering
                  <img src="/smart-mastering-core/images/smart-mastering.svg" width="36x" height="36px">
                </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    
                        <li  >
                            
                            <a href="/smart-mastering-core/">Getting Started</a>
                            
                        </li>
                    
                        <li  >
                            
                            <a href="https://github.com/marklogic-community/smart-mastering-core">GitHub</a>
                            
                        </li>
                    
                </ul>
            </div>
        </div>
    </nav>




  <article>
    <div class="container">
      <div class="row">
        <div class="side-nav col-md-3 hide-small">
          <div class="panel panel-default">
  <div class="panel-heading">Navigation</div>
  <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/">Getting Started</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/how-does-it-work/">How Does it Work?</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/how-to-use/">How do I Use it?</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/">Docs</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/rest/">REST API</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/libraries/">Libraries</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/matching-options/">Matching Options</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/match-algorithms/">Included Matching Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/custom-match-algorithms/">Custom Matching Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/actions/">Included Actions</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/custom-actions/">Custom Actions</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/merging-options/">Merging Options</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/merge-algorithms/">Included Merging Algorithms</a>
    
    
  </li>
  
  <li  class="list-group-item active"  >
    
    <a href="/smart-mastering-core/docs/custom-merge-algorithms/">Custom Merging Algorithms</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/managing-code/">Managing Custom Code</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/security/">Security</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/docs/error-codes/">Error Codes</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/faqs/">FAQs</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/smart-mastering-core/troubleshooting/">Troubleshooting</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="https://github.com/marklogic-community/smart-mastering-core">Smart Mastering on GitHub</a>
    
    
  </li>
  
</ul>

</div>

        </div>
        <div class="col-md-9">
          <h1 id="custom-merge-algorithms">Custom Merge Algorithms</h1>

<p>Smart Mastering provides out-of-the-box merging capabilities, but you may want to customize how that merging happens. 
The default behavior is to grab all the values from matching documents, sort them on weight, then return the first 
<code class="highlighter-rouge">@max-values</code> values (see <a href="/docs/matching-options/">Matching Options</a>). If <code class="highlighter-rouge">@max-values</code> is not set, then the first 99 values are returned.</p>

<p>If you want to take more control over what it means for two property values to merge, you can do so by implementing 
your own algorithm in a function. Create a function with the signature below. Return a subset of the properties passed
into the function.</p>

<h2 id="customizing-merging">Customizing Merging</h2>

<h3 id="custom-merging-with-javascript">Custom Merging with JavaScript</h3>

<p>Here is the JavaScript function signature for a custom merge algorithm:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">customMerge</span><span class="p">(</span>
  <span class="nx">propertyName</span><span class="p">,</span>
  <span class="nx">properties</span><span class="p">,</span>
  <span class="nx">propertySpec</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">propertyName</code> is simply the name of the JSON property that holds the instance property being merged. The 
<code class="highlighter-rouge">properties</code> parameter is a sequence of JavaScript objects that provide information about property values from the 
source documents, along with lineage information. Each object has three keys: <code class="highlighter-rouge">sources</code>, <code class="highlighter-rouge">values</code>, and <code class="highlighter-rouge">name</code>. The 
value for <code class="highlighter-rouge">sources</code> is itself an object, with keys <code class="highlighter-rouge">name</code> (an identifier) extracted from the source; <code class="highlighter-rouge">dateTime</code> (an 
<code class="highlighter-rouge">xs:dateTime</code>) extracted from the source, if available; and <code class="highlighter-rouge">documentUri</code> (identifying this particular source 
document). The <code class="highlighter-rouge">values</code> key connects to the property value or values from this particular source document. The <code class="highlighter-rouge">name</code> 
key is the name of the property value.</p>

<p>The <code class="highlighter-rouge">propertySpec</code> parameter is the JSON obejct from the merging properties that corresponds to the property for which 
the algorithm is being used.</p>

<h3 id="custom-merging-with-xquery">Custom Merging with XQuery</h3>

<p>Here is the XQuery function signature for a custom merge algorithm:</p>

<div class="language-xquery highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">declare</span> <span class="kd">function</span> <span class="nf">custom-merging:customThing</span><span class="p">(</span>
  <span class="nv">$</span><span class="n">property-name</span> <span class="k">as</span> <span class="kt">xs:QName</span><span class="p">,</span>
  <span class="nv">$</span><span class="n">properties</span> <span class="k">as</span> <span class="kt">map:map</span><span class="o">*</span><span class="p">,</span>
  <span class="nv">$</span><span class="n">property-spec</span> <span class="k">as</span> <span class="nt">element</span><span class="p">(</span><span class="n">merging:merge</span><span class="p">)</span><span class="o">?</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">$property-name</code> is simply a QName identifying the property. The <code class="highlighter-rouge">$properties</code> parameter is a sequence of map:maps 
that provide information about property values from the source documents, along with lineage information. Each map has
three keys: <code class="highlighter-rouge">sources</code>, <code class="highlighter-rouge">values</code>, and <code class="highlighter-rouge">name</code>. The value for <code class="highlighter-rouge">sources</code> is itself a map, with keys <code class="highlighter-rouge">name</code> (an identifier)
extracted from the source; <code class="highlighter-rouge">dateTime</code> (an <code class="highlighter-rouge">xs:dateTime</code>) extracted from the source, if available; and <code class="highlighter-rouge">documentUri</code> 
(identifying this particular source document). The <code class="highlighter-rouge">values</code> key connects to the property value or values from this 
particular source document. The <code class="highlighter-rouge">name</code> key is the name of the property value.</p>

<p>The <code class="highlighter-rouge">$property-spec</code> parameter is the <code class="highlighter-rouge">merging:merge</code> element from the merging properties that corresponds to the 
property for which the algorithm is being used.</p>

<h2 id="configuring-options-to-use-custom-merge-functions">Configuring Options to Use Custom Merge Functions</h2>

<p>To use your custom merge functions, add them to the <code class="highlighter-rouge">algorithms</code> section of your merge options. The 
<code class="highlighter-rouge">algorithm-ref</code>/<code class="highlighter-rouge">algorithmRef</code> used for the <code class="highlighter-rouge">merge</code> and <code class="highlighter-rouge">merge-strategy</code> definitions refers to the name you assign in the <code class="highlighter-rouge">algorithms</code> 
section.</p>

<p>The <code class="highlighter-rouge">algorithm</code> needs <code class="highlighter-rouge">name</code>, <code class="highlighter-rouge">at</code>, <code class="highlighter-rouge">function</code>, and for XQuery functions, <code class="highlighter-rouge">ns</code> in order to find your custom code. The 
<code class="highlighter-rouge">at</code> property is the absolute path the library module in the modules database that holds your function. <code class="highlighter-rouge">ns</code> is the 
namespace in an XQuery library module. <code class="highlighter-rouge">function</code> is the actual name of the function (not including the namespace or 
prefix for XQuery code).</p>

<h3 id="xml-options">XML Options</h3>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;algorithms&gt;</span>
    <span class="nt">&lt;algorithm</span> 
      <span class="na">name=</span><span class="s">"favorite-color"</span> 
      <span class="na">at=</span><span class="s">"/smart-mastering/merge/favorite-color.xqy"</span> 
      <span class="na">ns=</span><span class="s">"http://example.com/big-hub/smart-mastering/merge/favorite-color"</span>
      <span class="na">function=</span><span class="s">"favorite-color"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/algorithms&gt;</span>
</code></pre></div></div>

<h3 id="json-options">JSON Options</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="s2">"algorithms"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"custom"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> 
          <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"favoriteColor"</span><span class="p">,</span> 
          <span class="s2">"at"</span><span class="p">:</span> <span class="s2">"/smart-mastering/merge/favoriteColor.sjs"</span>
          <span class="s2">"function"</span><span class="p">:</span> <span class="s2">"favoriteColor"</span> 
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
</code></pre></div></div>

        </div>
      </div>
    </div>
  </article>


    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>
                    Copyright © 2016-2018 MarkLogic Corporation. All Rights Reserved. MARKLOGIC® is a registered trademark of MarkLogic Corporation.
                    </p>
                </div>
            </div>
        </div>
    </footer>


    <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="/smart-mastering-core/js/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/smart-mastering-core/assets/bundle.js" id="1"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-79716597-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>

